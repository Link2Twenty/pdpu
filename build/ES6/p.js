import{XtallatX}from"./node_modules/xtal-latx/xtal-latx.js";const on="on",noblock="noblock",iff="if",to="to";export class P extends XtallatX(HTMLElement){constructor(){super();this._addedSMO=!1;this._connected=!1}get on(){return this._on}set on(val){this.attr(on,val)}get to(){return this._to}set to(val){this.attr(to,val)}get noblock(){return this._noblock}set noblock(val){this.attr(noblock,val,"")}get if(){return this._if}set if(val){this.attr(iff,val)}get input(){return this._input}set input(val){this._input=val}static get observedAttributes(){return super.observedAttributes.concat([on,to,noblock,iff])}attributeChangedCallback(name,oldVal,newVal){const f="_"+name;switch(name){case iff:case on:this[f]=newVal;break;case to:this._destIsNA="{NA}"===newVal;if(newVal.endsWith("}"))newVal+=";";this._to=newVal;this.parseTo();if(this._lastEvent)this._handleEvent(this._lastEvent);break;case noblock:this[f]=null!==newVal;break;}super.attributeChangedCallback(name,oldVal,newVal)}getPreviousSib(){let prevSibling=this;while(prevSibling&&prevSibling.tagName.startsWith("P-")){prevSibling=prevSibling.previousElementSibling}return prevSibling}connectedCallback(){this.style.display="none";this._upgradeProperties([on,to,noblock,"input",iff]);setTimeout(()=>this.doFake(),50)}doFake(){if(!this._if&&!this.hasAttribute("skip-init")){let lastEvent=this._lastEvent;if(!lastEvent){lastEvent={target:this.getPreviousSib(),isFake:!0}}if(this._handleEvent)this._handleEvent(lastEvent)}if(!this._addedSMO&&this.addMutationObserver){this.addMutationObserver(this,!1);this._addedSMO=!0}}detach(prevSibling){prevSibling.removeEventListener(this._on,this._boundHandleEvent)}disconnectedCallback(){const prevSibling=this.getPreviousSib();if(prevSibling&&this._boundHandleEvent)this.detach(prevSibling);this.disconnect()}_handleEvent(e){if(this.hasAttribute("debug"))debugger;if(!e)return;if(e.stopPropagation&&!this._noblock)e.stopPropagation();if(this._if&&!e.target.matches(this._if))return;this._lastEvent=e;if(!this._cssPropMap){return}this.pass(e)}attachEventListeners(){const prevSibling=this.getPreviousSib();if(!prevSibling)return;if(this._boundHandleEvent){return}else{this._boundHandleEvent=this._handleEvent.bind(this)}prevSibling.addEventListener(this._on,this._boundHandleEvent);prevSibling.removeAttribute("disabled")}onPropsChange(){if(!this._connected||!this._on||!this._to)return;this.attachEventListeners()}parseMapping(mapTokens,cssSelector){const splitPropPointer=mapTokens[1].split(":");this._cssPropMap.push({cssSelector:cssSelector,propTarget:splitPropPointer[0],propSource:0<splitPropPointer.length?splitPropPointer[1]:void 0})}parseTo(){if(this._cssPropMap&&this._to===this._lastTo)return;this._lastTo=this._to;this._cssPropMap=[];const splitPassDown=this._to.split("};"),onlyOne=2>=splitPassDown.length;splitPassDown.forEach(passDownSelectorAndProp=>{if(!passDownSelectorAndProp)return;const mapTokens=passDownSelectorAndProp.split("{");let cssSelector=mapTokens[0];if(!cssSelector&&onlyOne){cssSelector="*";this._m=1;this._hasMax=!0}this.parseMapping(mapTokens,cssSelector)})}setVal(e,target,map){const gpfp=this.getPropFromPath.bind(this),propFromEvent=map.propSource?gpfp(e,map.propSource):gpfp(e,"detail.value")||gpfp(e,"target.value");this.commit(target,map,propFromEvent)}commit(target,map,val){target[map.propTarget]=val}getPropFromPath(val,path){if(!path||"."===path)return val;return this.getProp(val,path.split("."))}getProp(val,pathTokens){let context=val,firstToken=!0;const cp="composedPath";pathTokens.forEach(token=>{if(context){if(firstToken&&context[cp]){firstToken=!1;const cpath=token.split(cp+"_");if(1===cpath.length){context=context[cpath[0]]}else{context=context[cp]()[parseInt(cpath[1])]}}else{context=context[token]}}});return context}disconnect(){if(this._sibObs)this._sibObs.disconnect()}}